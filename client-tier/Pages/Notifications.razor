@page "/notifications"
@inject AuthService AuthService
@inject NotificationService NotificationService

<h1 style="margin-bottom: 1.5rem;">ðŸ”” Notifications</h1>

<div class="card">
    @if (isLoading)
    {
        <p style="text-align: center; padding: 2rem;">Loading notifications...</p>
    }
    else if (!notifications.Any())
    {
        <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            You have no notifications.
        </p>
    }
    else
    {
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            @foreach (var notification in notifications)
            {
                <div class="card" style="margin: 0; background: @(notification.Status == "READ" ? "var(--bg-color)" : "white"); border-left: 4px solid @GetTypeColor(notification.Type);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <span class="badge" style="background: @GetTypeColor(notification.Type)20; color: @GetTypeColor(notification.Type);">
                                @notification.Type
                            </span>
                            <p style="margin: 0.5rem 0;">@notification.Message</p>
                            <small style="color: var(--text-secondary);">@notification.CreatedAt</small>
                        </div>
                        @if (notification.Status != "READ")
                        {
                            <button class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                    @onclick="() => MarkAsRead(notification.NotificationId)">
                                Mark Read
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<NotificationModel> notifications = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotifications();
    }

    private async Task LoadNotifications()
    {
        isLoading = true;
        var user = AuthService.CurrentUser;
        if (user != null)
        {
            notifications = await NotificationService.GetUserNotificationsAsync(user.UserType, user.UserId);
            notifications = notifications.OrderByDescending(n => n.CreatedAt).ToList();
        }
        isLoading = false;
    }

    private async Task MarkAsRead(long notificationId)
    {
        await NotificationService.MarkAsReadAsync(notificationId);
        var notification = notifications.FirstOrDefault(n => n.NotificationId == notificationId);
        if (notification != null)
        {
            notification.Status = "READ";
        }
    }

    private string GetTypeColor(string type)
    {
        return type switch
        {
            "BOOKING_CONFIRMATION" => "var(--success-color)",
            "CANCELLATION" => "var(--danger-color)",
            "REMINDER" => "var(--warning-color)",
            "UPDATE" => "var(--primary-color)",
            _ => "var(--secondary-color)"
        };
    }
}

